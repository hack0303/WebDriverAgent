name: Build WDA for iOS 18 (Real Device)
on: workflow_dispatch  # 允许手动按钮触发

jobs:
  build-ios:
    name: Build WebDriverAgentRunner
    runs-on: macos-14 # macOS Sonoma 支持 Xcode 16 (iOS 18 SDK)
    env:
      XCODE_VERSION: "16.2" # 修复: 更新为环境支持的 16.2 版本
      WDA_SCHEME: "WebDriverAgentRunner"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 使用官方推荐的 Action 设置 Xcode 版本，比手动 select 更稳健
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Debug File Structure
        run: ls -R

      # 依赖与环境修复 (针对 iOS 18)
      - name: Prepare & Fix Project
        run: |
          # 1. 如果有 package.json，安装 npm 依赖 (防止 Inspector 缺少依赖报错)
          if [ -f "package.json" ]; then
            npm config set legacy-peer-deps true
            npm install
          fi

          # 2. 暴力修复 Xcode 16 私有框架权限问题 (删除显式引用)
          # 这步是绕过 "not an allowed client" 链接错误的关键
          if [ -f "WebDriverAgent.xcodeproj/project.pbxproj" ]; then
            sed -i '' '/XCTAutomationSupport.framework/d' WebDriverAgent.xcodeproj/project.pbxproj
            echo "✅ Removed XCTAutomationSupport reference for iOS 18 compatibility."
          fi

      # 核心构建步骤 (不依赖外部 .sh 脚本，直接内联构建逻辑)
      - name: Build Unsigned IPA
        run: |
          # 创建输出目录
          mkdir -p Payload

          # 执行 xcodebuild
          # 关键参数说明:
          # - IPHONEOS_DEPLOYMENT_TARGET=16.0: 强制提升最低版本以适配 Xcode 16
          # - undefined dynamic_lookup: 允许运行时查找私有符号，配合上面的 sed 使用
          xcodebuild build-for-testing \
            -project WebDriverAgent.xcodeproj \
            -scheme "${{ env.WDA_SCHEME }}" \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -derivedDataPath ./Build/ \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_ENTITLEMENTS="" \
            CODE_SIGNING_ALLOWED=NO \
            IPHONEOS_DEPLOYMENT_TARGET=16.0 \
            GCC_TREAT_WARNINGS_AS_ERRORS=NO \
            OTHER_LDFLAGS="-Wl,-undefined,dynamic_lookup"

          # 查找并打包 IPA
          # 注意: build-for-testing 的产物路径可能有所不同，这里使用 find 覆盖查找
          APP_PATH=$(find ./Build -name "WebDriverAgentRunner-Runner.app" | head -n 1)

          if [ -d "$APP_PATH" ]; then
            echo "✅ Found App at: $APP_PATH"
            cp -r "$APP_PATH" ./Payload/
            zip -r WDA_iOS18_Unsigned.ipa Payload
          else
            echo "❌ Build failed: WebDriverAgentRunner-Runner.app not found in ./Build/"
            find ./Build -maxdepth 4 # 打印目录帮助排错
            exit 1
          fi

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: WDA_iOS18_Unsigned
          path: WDA_iOS18_Unsigned.ipa
